# Template: Linux eBPF Event Monitoring
# Platform: linux
# Use when: Real-time kernel-level event monitoring using eBPF (process, network, file events)

# =============================================================================
# Based on: Linux.Events.DNS, Linux.Events.TrackProcesses, Linux.Events.EBPF
#
# Patterns demonstrated:
#   - type: CLIENT_EVENT for continuous monitoring
#   - watch_ebpf(events=) for kernel event collection
#   - delay() wrapper to allow eBPF programs to initialize
#   - CSV parameter for user-selectable event list
#   - process_tracker_get() for process enrichment
#   - Regex filtering on multiple fields
#
# Prerequisites:
#   - Linux kernel 4.4+ with eBPF support
#   - Velociraptor running with appropriate kernel capabilities
#   - High-volume events (openat, openat2) are extremely noisy â€” use filters
#
# Common eBPF events:
#   Process:  sched_process_exec, sched_process_exit
#   Network:  security_socket_connect, security_socket_bind, security_socket_accept
#   DNS:      net_packet_dns (separate event, protocol-level)
#   File:     security_file_open, unlink, security_inode_rename
#   System:   mount, umount2, kill, module_free, bpf_attach
# =============================================================================

name: Linux.Events.ArtifactName        # TODO: Set artifact name
description: |
  TODO: One-line summary of what kernel events this artifact monitors.

  Describe: which eBPF events are captured, what filtering is applied,
  and the security or forensic value of the monitoring.

  Requires Linux kernel 4.4+ with eBPF support.

type: CLIENT_EVENT                     # Required for continuous monitoring
author: TODO Author Name - @handle

precondition: SELECT OS FROM info() WHERE OS =~ 'linux'

parameters:
  - name: Events
    description: Select which eBPF events to monitor. Set Enabled=Y to enable.
    type: csv
    default: |
      Event,Description,Enabled
      sched_process_exec,Process execution,Y
      sched_process_exit,Process exit,N
      security_socket_connect,Outbound connection,Y
      security_socket_bind,Port bind,Y
      security_socket_accept,Inbound connection,Y
      security_file_open,File open (noisy),N
      unlink,File deletion,Y
      security_inode_rename,File rename,N
      security_inode_symlink,Symlink creation,Y
      mount,Filesystem mount,Y
      umount2,Filesystem unmount,Y
      kill,Signal sent between processes,Y
      module_free,Kernel module unloaded,Y
      bpf_attach,BPF program attached,Y

  - name: ProcessNameFilter
    description: Filter events by process name (regex).
    type: regex
    default: .

  - name: PathFilter
    description: Filter file events by path (regex). Empty = no filter.
    type: regex
    # default: /tmp/.*

  - name: NetworkFilter
    description: Filter network events by IP or port (regex). Empty = no filter.
    type: regex
    # default: 192\.168\.1\..*

  - name: ExcludeDestIP
    description: Exclude network events to these destination IPs (regex).
    type: regex
    # default: 127\.0\.0\.1

  - name: IncludeProcessInfo
    type: bool
    description: Enrich events with process data from the process tracker.
    # Requires Linux.Events.TrackProcesses to be running

  - name: IncludeRawEventData
    type: bool
    description: Include raw EventData struct in output for deep analysis.

sources:
  - query: |
      -- Select enabled events from CSV parameter
      LET SelectedEvents <= SELECT Event FROM Events WHERE Enabled =~ "Y"

      -- watch_ebpf() is wrapped in delay() to allow eBPF programs to attach
      -- before events begin flowing. delay=2 waits 2 seconds.
      SELECT System.Timestamp AS Timestamp,
             System.EventName AS EventName,
             System.ProcessName AS ProcessName,
             System.ProcessID AS Pid,
             System.HostProcessID AS HostPid,
             System.ParentProcessID AS Ppid,
             System.UserID AS Uid,

             -- Process enrichment (requires Linux.Events.TrackProcesses running)
             if(condition=IncludeProcessInfo,
                then=process_tracker_get(id=System.HostProcessID).Data) AS ProcessInfo,

             -- Process events: sched_process_exec
             join(array=EventData.argv, sep=" ") AS CommandLine,
             EventData.cmdpath AS ExecutablePath,

             -- Network events: security_socket_connect, security_socket_bind
             EventData.src AS SourceIP,
             EventData.src_port AS SourcePort,
             EventData.dst AS DestIP,
             EventData.dst_port AS DestPort,

             -- File events: unlink, security_inode_rename, security_inode_symlink
             EventData.pathname AS Pathname,
             EventData.old_dentry AS OldPath,
             EventData.new_dentry AS NewPath,

             -- DNS events (net_packet_dns only):
             -- EventData.proto_dns.questions.name AS DNSQuery,
             -- EventData.proto_dns.questions.type AS DNSType,
             -- EventData.proto_dns.answers.IP AS ResolvedIP,

             if(condition=IncludeRawEventData,
                then=EventData) AS _EventData

      FROM delay(delay=2, query={
        SELECT * FROM watch_ebpf(events=SelectedEvents.Event)
      })

      -- Apply filters
      WHERE ProcessName =~ ProcessNameFilter

        AND if(condition=PathFilter,
               then=(EventData.pathname =~ PathFilter
                     OR EventData.old_dentry =~ PathFilter
                     OR EventData.new_dentry =~ PathFilter),
               else=TRUE)

        AND if(condition=NetworkFilter,
               then=(EventData.dst =~ NetworkFilter
                     OR EventData.src =~ NetworkFilter),
               else=TRUE)

        AND if(condition=ExcludeDestIP,
               then=NOT EventData.dst =~ ExcludeDestIP,
               else=TRUE)

      -- TODO: Add additional WHERE conditions for your use case
