# Template: Windows Sigma Rule Evaluation
# Platform: windows
# Use when: Evaluating Sigma detection rules against Windows event logs

# =============================================================================
# Based on: Windows.Sigma.EventLogs
#
# Sigma rules are a generic detection format for log data.
# Velociraptor uses the sigma() VQL plugin to evaluate them against
# parsed event logs.
#
# Pattern demonstrated:
#   - Load Sigma rules (inline or from file)
#   - Parse event logs with parse_evtx()
#   - Evaluate with sigma() plugin against a log source mapping
#   - Map log sources to actual event data structure
# =============================================================================

name: Windows.Sigma.ArtifactName       # TODO: Set artifact name
description: |
  TODO: One-line summary of what Sigma rules this artifact evaluates.

  Describe: which log sources are covered, what threat detections are targeted,
  and how Sigma rules are loaded (inline, uploaded, or from a URL).

type: CLIENT
author: TODO Author Name - @handle

precondition: SELECT OS FROM info() WHERE OS =~ 'windows'

parameters:
  - name: InlineSigmaRules
    type: yara                          # yara type used for multi-line text blocks
    description: Paste Sigma rules here (YAML, separate multiple rules with ---)
    default: |
      title: Suspicious PowerShell Execution
      status: experimental
      logsource:
        category: process_creation
        product: windows
      detection:
        selection:
          Image|endswith: '\powershell.exe'
          CommandLine|contains: '-EncodedCommand'
        condition: selection
      ---

  - name: SigmaRuleFile
    type: upload
    description: Upload a file containing Sigma rules (overrides inline rules).

  - name: DateAfter
    type: timestamp
    description: "Search for events after this date."

  - name: DateBefore
    type: timestamp
    description: "Search for events before this date."

  - name: Debug
    type: bool
    default: N
    description: Enable debug output from the Sigma engine.

sources:
  - query: |
      LET DateAfterTime <= if(condition=DateAfter,
        then=DateAfter, else=timestamp(epoch="1600-01-01"))
      LET DateBeforeTime <= if(condition=DateBefore,
        then=DateBefore, else=timestamp(epoch="2200-01-01"))

      -- Combine inline rules with uploaded file (uploaded takes precedence)
      LET Rules = InlineSigmaRules ||
        if(condition=SigmaRuleFile, then=SigmaRuleFile)

      -- Define which log source maps to which event log file
      -- This mapping tells the Sigma engine where to find log data
      LET StandardSigmaLogSource <= sigma_log_sources(
        `process_creation/windows`={
          SELECT *
          FROM parse_evtx(filename=expand(
            path='%SystemRoot%\\System32\\winevt\\logs\\Microsoft-Windows-Sysmon%4Operational.evtx'))
          WHERE System.EventID.Value = 1
            AND System.TimeCreated.SystemTime > DateAfterTime
            AND System.TimeCreated.SystemTime < DateBeforeTime
        })
      -- TODO: Add more log source mappings for your rules:
      -- `network_connection/windows`={...}
      -- `registry_event/windows`={...}

      -- Evaluate Sigma rules against the log source
      SELECT * FROM sigma(
        rules=split(string=Rules, sep_string="\n---\n"),
        log_sources=StandardSigmaLogSource,
        debug=Debug)
