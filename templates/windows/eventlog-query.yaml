# Template: Windows Event Log (EVTX) Query
# Platform: windows
# Use when: Parsing .evtx event log files, filtering by Event ID, date range, or content

# =============================================================================
# Based on: Windows.EventLogs.EvtxHunter, Windows.EventLogs.RDPAuth,
#           Windows.EventLogs.PowershellScriptblock
#
# Patterns demonstrated:
#   A. Simple EVTX parsing with Event ID filter
#   B. VSS-aware EVTX search with deduplication (GROUP BY)
#   C. Multi-channel aggregation with EventData vs UserData extraction
# =============================================================================

name: Windows.EventLogs.ArtifactName   # TODO: Set artifact name
description: |
  TODO: One-line summary of what this artifact parses from event logs.

  Describe: which log channels are queried, which Event IDs are relevant,
  and what detection or forensic value this provides.

type: CLIENT
author: TODO Author Name - @handle

precondition: SELECT OS FROM info() WHERE OS =~ 'windows'

parameters:
  - name: EvtxGlob
    description: Glob pattern for target event log files.
    default: '%SystemRoot%\System32\Winevt\Logs\Security.evtx'
    # Common paths:
    #   '%SystemRoot%\System32\Winevt\Logs\*.evtx'           â€” all logs
    #   '%SystemRoot%\System32\winevt\logs\Microsoft-Windows-Sysmon%4Operational.evtx'
    #   '%SystemRoot%\System32\Winevt\Logs\System.evtx'

  - name: DateAfter
    type: timestamp
    description: "Search for events after this date. YYYY-MM-DDTmm:hh:ssZ"

  - name: DateBefore
    type: timestamp
    description: "Search for events before this date. YYYY-MM-DDTmm:hh:ssZ"

  - name: SearchStrings
    type: regex
    description: Regex filter over event data fields.

  - name: VSSAnalysisAge
    type: int
    default: 0
    description: |
      If larger than zero, analyze VSS snapshots within this many days ago.
      When set, the ntfs_vss accessor is used (much slower).

sources:
  - query: |
      -- Time bounds for performance
      LET DateAfterTime <= if(condition=DateAfter,
        then=timestamp(epoch=DateAfter), else=timestamp(epoch="1600-01-01"))
      LET DateBeforeTime <= if(condition=DateBefore,
        then=timestamp(epoch=DateBefore), else=timestamp(epoch="2200-01-01"))

      -- VSS accessor selection
      LET VSS_MAX_AGE_DAYS <= VSSAnalysisAge
      LET Accessor = if(condition=VSSAnalysisAge > 0, then="ntfs_vss", else="auto")

      LET fspaths = SELECT OSPath
        FROM glob(globs=expand(path=EvtxGlob), accessor=Accessor)

      -- =====================================================================
      -- PATTERN A: Simple EVTX parsing with Event ID filter
      -- =====================================================================
      LET events = SELECT * FROM foreach(
        row=fspaths,
        query={
          SELECT timestamp(epoch=int(int=System.TimeCreated.SystemTime)) AS EventTime,
                 System.Computer AS Computer,
                 System.Channel AS Channel,
                 System.EventID.Value AS EventID,
                 System.EventRecordID AS EventRecordID,
                 System.Security.UserID AS UserSID,
                 EventData,
                 get(field="Message") AS Message,
                 OSPath
          FROM parse_evtx(filename=OSPath, accessor=Accessor)
          WHERE System.EventID.Value IN (4624, 4625)   -- TODO: Set target Event IDs
            AND EventTime > DateAfterTime
            AND EventTime < DateBeforeTime
            AND if(condition=SearchStrings,
              then=format(format="%v", args=EventData) =~ SearchStrings,
              else=TRUE)
        })

      -- Deduplicate when using VSS
      SELECT * FROM if(condition=VSSAnalysisAge > 0,
        then={SELECT * FROM events GROUP BY EventRecordID, Channel},
        else={SELECT * FROM events})

      -- =====================================================================
      -- PATTERN B: Broad IOC search across all event logs (EvtxHunter style)
      -- Uncomment and replace Pattern A:
      -- =====================================================================
      -- LET evtxsearch(PathList) = SELECT * FROM foreach(
      --   row=PathList,
      --   query={
      --     SELECT timestamp(epoch=int(int=System.TimeCreated.SystemTime)) AS EventTime,
      --            System.Computer AS Computer, System.Channel AS Channel,
      --            System.Provider.Name AS Provider,
      --            System.EventID.Value AS EventID,
      --            System.EventRecordID AS EventRecordID,
      --            get(field="EventData") AS EventData,
      --            get(field="UserData") AS UserData,
      --            get(field="Message") AS Message, OSPath
      --     FROM parse_evtx(filename=OSPath, accessor=Accessor)
      --     WHERE EventTime > DateAfterTime AND EventTime < DateBeforeTime
      --       AND format(format='%v %v %v', args=[EventData, UserData, Message])
      --           =~ SearchStrings
      --   })
      -- SELECT * FROM if(condition=VSSAnalysisAge > 0,
      --   then={SELECT * FROM evtxsearch(PathList=fspaths) GROUP BY EventRecordID, Channel},
      --   else={SELECT * FROM evtxsearch(PathList=fspaths)})

column_types:
  - name: EventTime
    type: timestamp
