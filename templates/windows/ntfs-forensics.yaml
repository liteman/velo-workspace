# Template: Windows NTFS Forensics
# Platform: windows
# Use when: Parsing the MFT, monitoring the USN journal, or performing NTFS-level forensic analysis

# =============================================================================
# Based on: Windows.NTFS.MFT, Windows.Timeline.MFT, Windows.Forensics.Prefetch
#
# Patterns demonstrated:
#   A. MFT parsing with timestomp detection
#   B. USN journal monitoring (CLIENT_EVENT)
#   C. NTFS I30 index parsing for deleted file recovery
#   D. Alternate data stream (ADS) detection
# =============================================================================

name: Windows.NTFS.ArtifactName        # TODO: Set artifact name
description: |
  TODO: One-line summary of what NTFS forensic data this artifact collects.

  Describe: what NTFS structure is parsed (MFT, USN, I30, ADS),
  what filtering is applied, and the forensic value.

type: CLIENT                            # Use CLIENT_EVENT for USN journal monitoring
author: TODO Author Name - @handle

precondition: SELECT OS FROM info() WHERE OS =~ 'windows'

parameters:
  - name: Device
    description: The device/drive to analyze.
    default: "C:"

  - name: NameRegex
    type: regex
    default: .
    description: Filter MFT entries by filename.

  - name: PathRegex
    type: regex
    default: .
    description: Filter MFT entries by full path.

  - name: DateAfter
    type: timestamp
    description: "Only return entries modified after this date."

  - name: DateBefore
    type: timestamp
    description: "Only return entries modified before this date."

sources:
  - query: |
      -- =====================================================================
      -- PATTERN A: MFT parsing with comprehensive filters
      -- =====================================================================
      LET DateAfterTime <= if(condition=DateAfter,
        then=DateAfter, else=timestamp(epoch="1600-01-01"))
      LET DateBeforeTime <= if(condition=DateBefore,
        then=DateBefore, else=timestamp(epoch="2200-01-01"))

      -- NTFS root path for MFT access
      LET Root = pathspec(parse=Device, path_type="ntfs")

      SELECT EntryNumber,
             OSPath,
             FileName,
             FileSize,
             Created0x10 AS SICreated,
             Created0x30 AS FNCreated,
             LastModified0x10 AS SIModified,
             LastModified0x30 AS FNModified,
             -- Timestomp indicators: $STANDARD_INFO vs $FILE_NAME mismatch
             Created0x10 < Created0x30 AS FNCreatedShift,
             Created0x10 > LastModified0x10 AS PossibleCopy,
             IsDir
      FROM parse_mft(filename=Root + "$MFT", accessor="ntfs")
      WHERE InUse
        AND FileName =~ NameRegex
        AND OSPath =~ PathRegex
        AND SIModified > DateAfterTime
        AND SIModified < DateBeforeTime
        AND log(message="Processing MFT entry %v", args=EntryNumber, dedup=10000)

      -- =====================================================================
      -- PATTERN B: USN journal monitoring (CLIENT_EVENT)
      -- Change type: to CLIENT_EVENT above. Query never terminates.
      -- Uncomment and replace Pattern A:
      -- =====================================================================
      -- SELECT * FROM watch_usn(device=Device)
      -- WHERE OSPath =~ PathRegex
      --   AND FileName =~ NameRegex
      -- -- Filter specific USN reasons:
      -- -- AND Reason =~ "FILE_CREATE|RENAME_NEW_NAME|FILE_DELETE"

      -- =====================================================================
      -- PATTERN C: NTFS I30 index parsing (deleted file recovery)
      -- Uncomment and replace Pattern A:
      -- =====================================================================
      -- SELECT * FROM foreach(
      --   row={SELECT EntryNumber, OSPath FROM parse_mft(
      --     filename=Root + "$MFT", accessor="ntfs") WHERE IsDir AND InUse},
      --   query={SELECT * FROM parse_ntfs_i30(
      --     device=Device, inode=EntryNumber)})

      -- =====================================================================
      -- PATTERN D: Alternate data stream detection
      -- Uncomment and replace Pattern A:
      -- =====================================================================
      -- SELECT * FROM glob(globs="C:\\Users\\**\\*:Zone.Identifier")
      -- -- Zone.Identifier ADS indicates file downloaded from internet

column_types:
  - name: SICreated
    type: timestamp
  - name: FNCreated
    type: timestamp
  - name: SIModified
    type: timestamp
  - name: FNModified
    type: timestamp
